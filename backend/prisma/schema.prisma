// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. SYSTEM & TENANCY
// ==========================================

model Plan {
  id           String @id
  name         String
  priceMonthly Float
  priceYearly  Float
  features     String
  limits       String
}

model Tenant {
  id            String   @id @default(uuid())
  parentId      String?
  name          String
  plan          String   @default("Trial")
  billingPeriod String   @default("Monthly")
  settings      String   @default("{\"currency\":\"USD\",\"timezone\":\"UTC\"}")
  status        String   @default("Active")
  joinedDate    DateTime @default(now())
  storageUsed   Float    @default(0)

  // Relations
  users         User[]
  owners        Owner[]
  pets          Pet[]
  appointments  Appointment[]
  inventory     InventoryItem[]
  sales         SaleRecord[]
  consultations Consultation[]
  labResults    LabResult[]
  expenses      Expense[]
  logs          Log[]
  messages      Message[]
  clientUploads ClientUpload[]
  branches      Branch[]
}

model Branch {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  address   String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Log {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      String
  action    String
  type      String
  details   String?
  timestamp DateTime @default(now())
}

// ==========================================
// 2. AUTHENTICATION & USERS
// ==========================================

model User {
  id           String  @id @default(uuid())
  tenantId     String
  tenant       Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name         String
  email        String  @unique
  passwordHash String
  roles        String  @default("[\"Veterinarian\"]") // Stored as JSON string
  avatarUrl    String?
  isSuspended  Boolean @default(false)
  isVerified   Boolean @default(false)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model VerificationToken {
  id         String   @id @default(uuid())
  identifier String
  token      String
  type       String
  expires    DateTime
  createdAt  DateTime @default(now())

  @@unique([identifier, type])
}

// ==========================================
// 3. CLIENTS & PATIENTS
// ==========================================

model Owner {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientNumber String?  @default("CL-000")
  name         String
  email        String?
  phone        String
  address      String?
  
  // Portal Auth
  passwordHash   String? 
  isPortalActive Boolean  @default(false)
  lastLogin      DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  pets          Pet[]
  appointments  Appointment[]
  consultations Consultation[]
  sales         SaleRecord[]
  messages      Message[]
  uploads       ClientUpload[]
}

model Pet {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ownerId           String
  owner             Owner    @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  name              String
  species           String
  breed             String?
  age               Float    @default(0)
  gender            String
  type              String   @default("Single")
  color             String?
  imageUrl          String?

  // Medical History (Stored as JSON Strings)
  vitalsHistory     String   @default("[]")
  notes             String   @default("[]")
  allergies         String   @default("[]")
  medicalConditions String   @default("[]")
  reminders         String   @default("[]")
  vaccinations      String   @default("[]")

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  appointments      Appointment[]
  consultations     Consultation[]
  labResults        LabResult[]
}

// ==========================================
// 4. CLINICAL
// ==========================================

model Appointment {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  petId      String?
  pet        Pet?     @relation(fields: [petId], references: [id])
  ownerId    String?
  owner      Owner?   @relation(fields: [ownerId], references: [id])
  
  walkInName String?
  date       DateTime
  reason     String
  status     String   @default("Scheduled")
  doctorName String?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Consultation {
  id                  String   @id @default(uuid())
  tenantId            String
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  petId               String
  pet                 Pet      @relation(fields: [petId], references: [id])
  ownerId             String
  owner               Owner    @relation(fields: [ownerId], references: [id])

  date                DateTime @default(now())
  vetName             String
  status              String   @default("Draft")

  // SOAP Notes & Data
  chiefComplaint      String?
  history             String?
  previousTreatmentId String?
  previousDiagnosis   String?
  plan                String?

  // JSON Fields
  vitals              String   @default("{}")
  exam                String   @default("{}")
  diagnosis           String   @default("{}")
  labRequests         String   @default("[]")
  prescription        String   @default("[]")
  attachments         String   @default("[]")
  reminder            String   @default("{}")
  financials          String   @default("{}")
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model LabResult {
  id             String    @id @default(uuid())
  tenantId       String
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  petId          String?
  pet            Pet?      @relation(fields: [petId], references: [id])
  
  // Fields to match your routes.ts
  type           String    @default("General") // Matches 'type' in code
  date           DateTime  @default(now())     // Matches 'date' in code
  
  // Metadata
  patientName    String?
  ownerName      String?
  consultationId String?
  testName       String?   // Kept for backward compatibility
  
  status         String    @default("Pending")
  result         String?   // Text or JSON
  resultUrl      String?
  notes          String?
  requestedBy    String?
  conductedBy    String?
  cost           Float     @default(0)

  createdAt      DateTime  @default(now()) // Matches 'orderBy: createdAt' in code
  updatedAt      DateTime  @updatedAt
}

// ==========================================
// 5. INVENTORY & FINANCE
// ==========================================

model InventoryItem {
  id             String    @id @default(uuid())
  tenantId       String
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name           String
  category       String
  type           String    @default("Product")
  sku            String
  stock          Int       @default(0)
  purchasePrice  Float     @default(0)
  retailPrice    Float     @default(0)
  wholesalePrice Float     @default(0)
  reorderLevel   Int       @default(5)
  expiryDate     String?
  
  unit           String?   @default("pcs")
  location       String?
  batchNumber    String?
  supplier       String?
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model SaleRecord {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  ownerId       String?
  owner         Owner?   @relation(fields: [ownerId], references: [id])

  // Walk-in Client Info
  clientId      String?
  clientName    String?
  clientAddress String?
  clientEmail   String?
  clientPhone   String?
  
  date          DateTime @default(now())

  // JSON Data
  items         String   @default("[]")
  payments      String   @default("[]")

  subtotal      Float    @default(0)
  discount      Float    @default(0)
  tax           Float    @default(0)
  total         Float    @default(0)

  status        String   @default("Pending")
  invoiceNumber String?
  receiptNumber String?
  notes         String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Expense {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  date          DateTime @default(now())
  category      String
  description   String
  amount        Float
  paymentMethod String
  notes         String?
  createdAt     DateTime @default(now())
}

// ==========================================
// 6. CLIENT PORTAL EXTRAS
// ==========================================

model Message {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  ownerId   String
  owner     Owner    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  senderType String  // "Staff" or "Client"
  senderId   String  
  
  content    String
  isRead     Boolean @default(false)
  createdAt  DateTime @default(now())
}

model ClientUpload {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ownerId   String
  owner     Owner    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  fileName  String
  fileUrl   String
  fileType  String   // "Receipt", "Image", "Other"
  uploadedAt DateTime @default(now())
  notes     String?
}
